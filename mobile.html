<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mando Final P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; text-align: center; overflow: hidden; user-select: none; }
        .btn-start { margin-top: 40vh; padding: 15px 30px; font-size: 1.2rem; background: #007bff; color: white; border: none; border-radius: 50px; cursor: pointer; }
        
        .top-ui { width: 100%; height: 15vh; display: flex; justify-content: center; align-items: center; position: relative;}
        .arrow { font-size: 2.5rem; color: #333; transition: color 0.2s; position: absolute; }
        .arrow.left { left: 20px; } .arrow.right { right: 20px; }
        .arrow.active { color: #0f0; text-shadow: 0 0 10px #0f0; transform: scale(1.2); }
        #mode-indicator { font-size: 2rem; opacity: 0.5; transition: all 0.3s; }
        #mode-indicator.locked { color: #facc15; opacity: 1; transform: scale(1.2); }

        #country-card { flex: 1; width: 90%; max-width: 380px; border: 2px solid #444; border-radius: 20px; background: #1a1a1a; margin: 10px 0; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; gap: 10px; transition: all 0.3s ease; }
        #c-name { margin: 0; font-size: 1.5rem; color: white; min-height: 1.8rem;}
        .stat-row { display: flex; justify-content: space-around; }
        .stat-val { font-size: 1.4rem; font-weight: bold; }
        .label { font-size: 0.6rem; color: #aaa; text-transform: uppercase; }
        
        .btn-action { padding: 12px; border: none; border-radius: 12px; font-size: 0.9rem; font-weight: bold; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .btn-feel { background: #333; color: #facc15; border: 1px solid #facc15; }
        .btn-info { background: #007bff; color: white; }
        .tools-row { display: flex; gap: 10px; margin-top: 5px; }

        .extra-controls { display: flex; flex-direction: column; gap: 10px; background: #222; padding: 10px; border-radius: 10px; margin-top: 5px; }
        .vol-row { display: flex; align-items: center; gap: 10px; }
        .nav-row { display: flex; gap: 10px; }
        .btn-nav { flex: 1; background: #444; border: none; color: white; padding: 10px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-nav.active { background: #facc15; color: #111; } 
        .btn-nav.eye-active { background: #22c55e; color: #111; }

        .dolls-bar { width: 100%; height: 15vh; background: #222; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #444; }
        .doll-btn { background: none; border: none; cursor: pointer; opacity: 0.5; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; }
        .doll-btn svg { fill: #fff; height: 50px; width: auto; }
        .doll-btn.active { opacity: 1; transform: scale(1.2); }
        .doll-btn.active svg { fill: #007bff; filter: drop-shadow(0 0 8px #007bff); }
        .doll-label { font-size: 0.7rem; margin-top: 5px; color: #aaa; }
        body.nav-locked .arrow { opacity: 0.1; }
    </style>
</head>
<body>
    <div id="start-screen" style="position:absolute; top:0; left:0; width:100%; height:100%; background:#111; z-index:100;">
        <button class="btn-start" onclick="requestSensor()">‚úä Conectar</button>
    </div>

    <div class="top-ui">
        <div class="arrow left" id="left-arrow">‚óÄ</div>
        <div id="mode-indicator">‚ö™</div>
        <div class="arrow right" id="right-arrow">‚ñ∂</div>
    </div>

    <div id="country-card">
        <h2 id="c-name">Escaneando...</h2>
        <div class="stat-row">
            <div><div class="label">Obesidad</div><div id="c-obesity" class="stat-val">--</div></div>
            <div><div class="label">Diabetes</div><div id="c-diabetes" class="stat-val">--</div></div>
        </div>
        <div class="tools-row">
            <button class="btn-action btn-feel" onclick="feelSymptoms()"><span>üì≥</span> Sentir</button>
            <button id="btnInfo" class="btn-action btn-info" onclick="toggleInfo()"><span>‚ÑπÔ∏è</span> Info</button>
        </div>
        <div class="extra-controls">
            <div class="vol-row">
                <span style="font-size:0.8rem">üîä</span>
                <!-- Evento onchange para asegurar env√≠o final -->
                <input type="range" min="0" max="100" value="80" style="flex:1" oninput="sendEvent('mobile-set-volume', this.value)">
            </div>
            <div class="nav-row">
                <button id="btnLock" class="btn-nav" onclick="toggleManualLock()"><span id="lockIcon">üîì</span></button>
                <button id="btnOverview" class="btn-nav" onclick="toggleOverview()"><span>üëÅÔ∏è</span></button>
            </div>
        </div>
    </div>

    <div class="dolls-bar">
        <button class="doll-btn" id="btn-low" onclick="toggleDoll('low')">
            <svg viewBox="0 0 24 50"><path d="M12,0 C15,0 16,3 16,5 C16,8 14,10 14,12 L14,20 C14,20 13,35 13,35 L13,50 L11,50 L11,35 C11,35 10,20 10,20 L10,12 C10,10 8,8 8,5 C8,3 9,0 12,0 Z"/></svg><span class="doll-label">Bajo</span>
        </button>
        <button class="doll-btn" id="btn-mid" onclick="toggleDoll('mid')">
            <svg viewBox="0 0 30 50"><path d="M15,0 C19,0 20,3 20,5 C20,8 19,10 18,12 L19,20 C20,25 19,35 18,35 L17,50 L13,50 L12,35 C11,35 10,25 11,20 L12,12 C11,10 10,8 10,5 C10,3 11,0 15,0 Z"/></svg><span class="doll-label">Medio</span>
        </button>
        <button class="doll-btn" id="btn-high" onclick="toggleDoll('high')">
            <svg viewBox="0 0 40 50"><path d="M20,0 C24,0 25,3 25,5 C25,8 24,10 24,12 L26,18 C28,25 28,35 25,35 L23,50 L17,50 L15,35 C12,35 12,25 14,18 L16,12 C16,10 15,8 15,5 C15,3 16,0 20,0 Z"/></svg><span class="doll-label">Alto</span>
        </button>
    </div>

    <script>
        const peer = new Peer();
        let conn = null;

        function connectToHost() {
            const urlParams = new URLSearchParams(window.location.search);
            const hostId = urlParams.get('id');
            if (!hostId) { document.getElementById('c-name').innerText = "Error: Sin ID"; return; }
            document.getElementById('c-name').innerText = "Conectando...";
            conn = peer.connect(hostId);
            conn.on('open', () => { document.getElementById('c-name').innerText = "¬°Conectado!"; document.getElementById('start-screen').style.display = 'none'; });
            conn.on('data', (data) => { if (data.event === 'mobile-show-data') updateData(data.payload); });
            conn.on('error', (err) => { console.error(err); document.getElementById('c-name').innerText = "Error P2P"; });
        }
        function sendEvent(name, payload) { if (conn && conn.open) conn.send({ event: name, payload: payload }); }

        // UI
        const leftArrow = document.getElementById('left-arrow');
        const rightArrow = document.getElementById('right-arrow');
        const modeIndicator = document.getElementById('mode-indicator');
        const btnLock = document.getElementById('btnLock');
        const lockIcon = document.getElementById('lockIcon');
        const btnOverview = document.getElementById('btnOverview');
        
        let activeDoll = null; let isManualLocked = false; let isOverviewActive = false; let vibeInterval = null;

        // VIBRACI√ìN
        function startContinuousVibe(category) {
            stopContinuousVibe(); if (!navigator.vibrate) return;
            let pattern = 0, intervalTime = 1000;
            if (category === 'low') { pattern = 30; intervalTime = 100; } 
            else if (category === 'mid') { pattern = 100; intervalTime = 400; } 
            else if (category === 'high') { pattern = [300, 100]; intervalTime = 800; }
            const run = () => navigator.vibrate(pattern);
            run(); vibeInterval = setInterval(run, intervalTime);
        }
        function stopContinuousVibe() {
            if (vibeInterval) clearInterval(vibeInterval); vibeInterval = null;
            if (navigator.vibrate) navigator.vibrate(0);
        }

        // --- ESTADOS & BLOQUEO ---
        
        // NUEVA FUNCI√ìN: Detener cualquier movimiento en curso
        function stopNavLoop() {
            clearTimeout(repeatTimer); 
            clearInterval(repeatTimer); 
            repeatTimer = null;
            leftArrow.classList.remove('active');
            rightArrow.classList.remove('active');
        }

        function updateLockState() {
            const shouldLock = isManualLocked || isOverviewActive || (activeDoll !== null);
            if (shouldLock) {
                stopNavLoop(); // <--- IMPORTANTE: Matar el loop si bloqueamos
                document.body.classList.add('nav-locked');
                modeIndicator.classList.add('locked');
                if(isOverviewActive) modeIndicator.innerText = "üëÅÔ∏è"; else modeIndicator.innerText = "üîí";
            } else {
                document.body.classList.remove('nav-locked');
                modeIndicator.classList.remove('locked');
                modeIndicator.innerText = "‚ö™";
            }
        }

        function toggleManualLock() {
            if (isOverviewActive) toggleOverview(); 
            isManualLocked = !isManualLocked;
            if (isManualLocked) { btnLock.classList.add('active'); lockIcon.innerText = "üîí"; if(navigator.vibrate) navigator.vibrate(50); } 
            else { btnLock.classList.remove('active'); lockIcon.innerText = "üîì"; if(navigator.vibrate) navigator.vibrate([20, 20]); }
            updateLockState();
        }

        function toggleOverview() {
            if (isManualLocked) toggleManualLock(); 
            isOverviewActive = !isOverviewActive;
            if (isOverviewActive) { btnOverview.classList.add('eye-active'); if(navigator.vibrate) navigator.vibrate(50); } 
            else { btnOverview.classList.remove('eye-active'); if(navigator.vibrate) navigator.vibrate([20, 20]); }
            sendEvent('mobile-toggle-overview');
            updateLockState();
        }

        function toggleDoll(category) {
            if (isOverviewActive) toggleOverview();
            if (isManualLocked) toggleManualLock();
            if (activeDoll === category) {
                activeDoll = null;
                document.querySelectorAll('.doll-btn').forEach(btn => btn.classList.remove('active'));
                stopContinuousVibe();
                sendEvent('mobile-filter-doll', null);
            } else {
                activeDoll = category;
                document.querySelectorAll('.doll-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('btn-' + category).classList.add('active');
                startContinuousVibe(category);
                sendEvent('mobile-filter-doll', category);
            }
            updateLockState();
        }

        // SENSORES
        let tiltState = 0, repeatTimer = null;
        const THRESHOLD = 25, RESET_ZONE = 10;

        function handleOrientation(event) {
            if (document.body.classList.contains('nav-locked')) return;
            const tilt = event.gamma;
            let newState = 0;
            if (tilt > THRESHOLD) newState = 1; else if (tilt < -THRESHOLD) newState = -1; else if (tilt > -RESET_ZONE && tilt < RESET_ZONE) newState = 0; else newState = tiltState;
            if (newState !== tiltState) { tiltState = newState; processStateChange(newState); }
        }

        function processStateChange(state) {
            stopNavLoop(); // Limpiar anterior
            if (!document.body.classList.contains('nav-locked')) modeIndicator.innerText = "‚ö™"; 
            if (state === 0) return;
            triggerStep(state);
            repeatTimer = setTimeout(() => { 
                if(!document.body.classList.contains('nav-locked')) {
                    modeIndicator.innerText = "üöÄ"; 
                    repeatTimer = setInterval(() => triggerStep(state), 150); 
                }
            }, 500);
        }

        function triggerStep(dir) {
            if(navigator.vibrate) navigator.vibrate(15);
            if (dir === 1) { rightArrow.classList.add('active'); setTimeout(()=>rightArrow.classList.remove('active'), 100); }
            else { leftArrow.classList.add('active'); setTimeout(()=>leftArrow.classList.remove('active'), 100); }
            sendEvent('nav-step', dir);
        }

        function getColor(val, type) { const v = parseFloat(val); const th = type === 'diabetes' ? {l:7, h:14} : {l:15, h:25}; if (v < th.l) return "#22c55e"; if (v < th.h) return "#eab308"; return "#ef4444"; }
        function toggleInfo() { if(navigator.vibrate) navigator.vibrate(30); sendEvent('request-details'); }
        let currentDiabetes = 0;
        function feelSymptoms() { if(!navigator.vibrate) return; if(currentDiabetes > 15) navigator.vibrate([100, 50, 100, 50, 400]); else if(currentDiabetes > 8) navigator.vibrate([200, 100, 200]); else navigator.vibrate(50); }
        function updateData(data) {
            document.getElementById('c-name').innerText = data.name;
            const obVal = document.getElementById('c-obesity'); const diVal = document.getElementById('c-diabetes');
            obVal.innerText = data.obesity + "%"; diVal.innerText = data.diabetes + "%";
            obVal.style.color = getColor(data.obesity, 'obesity'); diVal.style.color = getColor(data.diabetes, 'diabetes');
            currentDiabetes = parseFloat(data.diabetes);
            document.getElementById('country-card').style.borderColor = getColor(data.diabetes, 'diabetes');
        }
        function requestSensor() { if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DeviceOrientationEvent.requestPermission().then(res => { if (res === 'granted') startApp(); }); } else startApp(); }
        function startApp() { connectToHost(); window.addEventListener("deviceorientation", handleOrientation, true); }
    </script>
</body>
</html>