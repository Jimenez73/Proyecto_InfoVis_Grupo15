<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Obesidad vs. Diabetes por paÃ­s</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <style>
    :root{
      --border:#e5e7eb; --txt:#111; --bg:#fff; --muted:#6b7280; --danger:#ef4444; --danger-bg:#fee2e2;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      margin:0; padding:.5rem; background:var(--bg); color:var(--txt); text-align:center;
    }
    h1{ margin:0; font-size:2rem; font-weight:600; }
    #chart{ width:90%; height:85vh; margin:0 auto; }

    /* Toolbar */
    .toolbar{
      position:fixed; top:12px; left:12px; z-index:20;
      display:flex; gap:10px; align-items:center;
      padding:4px;
      backdrop-filter:saturate(1.2) blur(6px);
    }
    .btn{
      width:40px; height:40px;
      display:inline-grid; place-items:center;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff; color:#111; cursor:pointer;
      box-shadow:0 1px 2px rgb(0 0 0 / 6%);
      transition:transform .06s ease, background .2s ease, color .2s ease, border-color .2s ease;
      font-size:18px; line-height:1;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    .btn.is-playing{
      background:var(--danger-bg); color:var(--danger); border-color:var(--danger);
    }
    .sr-only{
      position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
    }
  </style>
</head>
<body>

  <!-- Controles -->
  <div class="toolbar" aria-label="Controles de reproducciÃ³n y audio">
    <button id="playBtn" class="btn" aria-pressed="false" aria-label="Reproducir">
      â–¶
      <span class="sr-only">Play / Stop</span>
    </button>
    <button id="audioBtn" class="btn" aria-label="Silenciar / Activar sonido">ðŸ”‡</button>
  </div>

  <h1 style="margin:0 0 1rem;">Obesidad (color) vs. Diabetes (altura) por paÃ­s</h1>
  <div id="chart"></div>

<script>
(async function () {
  const res = await fetch("datos/datos.json");
  const data = await res.json();

  const rows = (data||[])
    .map(d => ({
      country: String(d.Country ?? "").trim(),
      obesity: Number(d.All_adults_Obesity),
      diabetes: Number(d.All_adults_Diabetes)
    }))
    .filter(d => d.country && Number.isFinite(d.obesity) && Number.isFinite(d.diabetes));

  if (!rows.length) return;

  rows.sort((a, b) => a.obesity - b.obesity);

  const xLabels = rows.map(r => r.country);
  const yValues = rows.map(r => r.diabetes);
  const xValues = rows.map(r => r.obesity);

  // RegresiÃ³n simple
  const n = xValues.length;
  const meanX = xValues.reduce((s, v) => s + v, 0) / n;
  const meanY = yValues.reduce((s, v) => s + v, 0) / n;
  let num = 0, den = 0;
  for (let i = 0; i < n; i++) { num += (xValues[i] - meanX) * (yValues[i] - meanY); den += (xValues[i] - meanX) ** 2; }
  const b = num / den;
  const a = meanY - b * meanX;

  const minX = Math.min(...xValues);
  const maxX = Math.max(...xValues);
  const yMinTrend = a + b * minX;
  const yMaxTrend = a + b * maxX;

  const minYVal = Math.min(...yValues);
  const maxYVal = Math.max(...yValues);

  // Barras
  const baseOpacity = Array(yValues.length).fill(0.9);
  const traceBars = {
    type: "bar",
    x: xLabels,
    y: yValues,
    marker: {
      color: xValues,
      colorscale: "Portland",
      cmin: minX, cmax: maxX,
      opacity: baseOpacity.slice(),
      colorbar: {
        title: "Obesidad (%)",
        titleside: "top",
        orientation: "h",
        x: 0.5, y: -0.3, xanchor: "center", yanchor: "top"
      },
      line: { width: 0.4, color: "#2b2b2b" }
    },
    hovertemplate:
      "<b>%{x}</b><br>Diabetes: %{y:.2f}%<br>Obesidad: %{marker.color:.2f}%<extra></extra>"
  };
  const refs = [
  { label: "10 %", country: "Philippines" },
  { label: "20 %", country: "Liberia" },
  { label: "30 %", country: "Libya" },
  { label: "40 %", country: "Mexico" },
];

const vlines = refs
  .map(r => ({ ...r, idx: xLabels.indexOf(r.country) }))
  .filter(r => r.idx >= 0)
  .map(r => ({ ...r, x: r.idx + 0.5 })); // borde derecho de la barra

  const layout = {
    margin: { t: 20, r: 30, b: 180, l: 60 },
    xaxis: {
      title: "PaÃ­s (ordenado por Obesidad, de menor a mayor)",
      tickangle: -60, tickfont: { size: 10 }, automargin: true,
      type: "category", categoryorder: "array", categoryarray: xLabels,
      layer: "below traces", showspikes: false
    },
    yaxis: { title: "Diabetes (%)", rangemode: "tozero", layer: "below traces", showspikes: false },
    bargap: 0.2,
    hovermode: "closest",
    dragmode: false,                 // cursor normal
    showlegend: false,
    paper_bgcolor: "white", plot_bgcolor: "white",
    hoverlabel: { bgcolor: "white", bordercolor: "#999", font: { color: "#111" } },
shapes: [
  {
    type: "line", xref: "paper", yref: "y",
    x0: 0, x1: 1, y0: yMinTrend, y1: yMaxTrend,
    line: { color: "blue", width: 2 }, layer: "above"
  },
  ...vlines.map(r => ({
    type: "line",
    xref: "x",
    yref: "paper",
    x0: r.x, x1: r.x,
    y0: 0, y1: 1,
    line: { color: "#9ca3af", width: 1.5, dash: "dot" },
    layer: "above"
  }))
]
,
annotations: [
  // Texto sobre la lÃ­nea de tendencia
  {
    x: 0.535,
    y: (yMinTrend + yMaxTrend) / 2 + 1,
    xref: "paper",
    yref: "y",
    text: "Tendencia general â†’ MÃ¡s obesidad, mÃ¡s diabetes",
    textangle: -8,
    showarrow: false,
    font: { size: 12, color: "blue" },
    align: "center",
    bgcolor: "#ffffff00",
    opacity: 1
  },

  // Caja izquierda "menor obesidad y diabetes"
  {
    x: 0.02,
    y: (yMinTrend + yMaxTrend) / 2 + 1,
    xref: "paper",
    yref: "y",
    text: "PaÃ­ses con <b>menor</b> obesidad y diabetes",
    showarrow: false,
    font: { size: 12, color: "gray" },
    align: "center",
    bgcolor: "#fff",
    opacity: 1
  },

  // Caja derecha "mayor obesidad y diabetes"
  {
    x: 0.87,
    y: 23,
    xref: "paper",
    yref: "y",
    text: "PaÃ­ses con <b>mayor</b> obesidad y diabetes",
    showarrow: false,
    font: { size: 12, color: "red" },
    align: "center",
    bgcolor: "#fff",
    opacity: 1
  },

  // Estrellas especiales (solo si existen esos Ã­ndices)
  ...(xLabels[51] ? [{
    x: xLabels[51],
    y: yValues[51],
    text: "â˜…",
    showarrow: false,
    font: { size: 24, color: "blue" },
    xanchor: "center",
    yanchor: "bottom"
  }] : []),
  ...(xLabels[33] ? [{
    x: xLabels[33],
    y: yValues[33],
    text: "â˜…",
    showarrow: false,
    font: { size: 24, color: "green" },
    xanchor: "center",
    yanchor: "bottom"
  }] : []),

  // Texto descriptivo de outliers (Aruba/Malasia)
  {
    x: 0.2,
    y: 0.8,
    xref: "paper",
    yref: "paper",
    text: "PaÃ­ses fuera de la norma:<br><span style='color:blue'>â˜…</span> Aruba: mucha obesidad â†‘ y poca diabetes â†“.<br><span style='color:green'>â˜…</span> Malasia: menor obesidad â†“ y mucha diabetes â†‘.",
    showarrow: false,
    font: { size: 12 },
    xanchor: "center",
    yanchor: "bottom",
    bgcolor: "#fff",
    opacity: 1
  },

  // Etiquetas de lÃ­neas verticales (vlines)
  ...vlines.map(r => ({
    xref: "x",
    yref: "paper",
    x: r.x,
    y: 1,
    text: r.label,
    showarrow: false,
    font: { size: 11, color: "#6b7280" },
    xanchor: "center",
    yanchor: "bottom"
  }))
]



};

  const config = { staticPlot: false, responsive: true, displaylogo: false, displayModeBar: false };

  const chartDiv = document.getElementById("chart");
  await Plotly.newPlot(chartDiv, [traceBars], layout, config);

  // ---- Audio ----
  const synth = new Tone.Synth({
    oscillator: { type: "triangle" },
    envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.3 }
  }).toDestination();

  function diabetesToMidi(v) {
    const midiMin = 48, midiMax = 84; // C3..C6
    const t = (v - minYVal) / Math.max(1e-9, (maxYVal - minYVal));
    return Math.round(midiMin + t * (midiMax - midiMin));
  }

  function setHighlight(idx) {
    const op = baseOpacity.slice();
    if (idx >= 0 && idx < op.length) {
      for (let i = 0; i < op.length; i++) op[i] = 0.25;
      op[idx] = 1.0;
    }
    Plotly.restyle(chartDiv, { "marker.opacity": [op] }, [0]);
  }

  // ---- Secuencia ----
  const playBtn = document.getElementById("playBtn");
  const audioBtn = document.getElementById("audioBtn");
  let playing = false, schedId = null, index = 0, audioEnabled = false;

  async function ensureAudioOn() {
    if (!audioEnabled) {
      await Tone.start();
      Tone.Destination.mute = false;
      audioEnabled = true;
      audioBtn.textContent = "ðŸ”Š";
    }
  }

  async function startSequence() {
    if (playing) return;
    await ensureAudioOn();          // PLAY habilita sonido automÃ¡ticamente
    playing = true;
    index = 0;
    playBtn.classList.add("is-playing");
    playBtn.setAttribute("aria-pressed", "true");
    playBtn.textContent = "â– ";      // cuadrado rojo
    Tone.Transport.bpm.value = 120;
    schedId = Tone.Transport.scheduleRepeat(time => {
      const i = index % yValues.length;
      const diabetes = yValues[i];
      const midi = diabetesToMidi(diabetes);
      const note = Tone.Frequency(midi, "midi").toNote();
      setHighlight(i);
      synth.triggerAttackRelease(note, "8n", time);
      index++;
      if (index >= yValues.length) stopSequence(); // una pasada
    }, "8n");
    Tone.Transport.start();
  }

  function stopSequence() {
    if (!playing) return;
    playing = false;
    if (schedId != null) { Tone.Transport.clear(schedId); schedId = null; }
    Tone.Transport.stop();
    Tone.Transport.position = 0;
    setHighlight(-1);
    playBtn.classList.remove("is-playing");
    playBtn.setAttribute("aria-pressed", "false");
    playBtn.textContent = "â–¶";
  }

  playBtn.addEventListener("click", () => {
    if (!playing) startSequence(); else stopSequence(); // clic en â–  resetea todo
  });

  // Mute / Unmute
  audioBtn.addEventListener("click", async () => {
    if (!audioEnabled) {
      await ensureAudioOn();
    } else {
      Tone.Destination.mute = !Tone.Destination.mute;
      audioBtn.textContent = Tone.Destination.mute ? "ðŸ”‡" : "ðŸ”Š";
    }
  });

  // Hover opcional cuando no estÃ¡ reproduciendo
  chartDiv.on("plotly_hover", ev => {
    if (!playing && audioEnabled && !Tone.Destination.mute) {
      const v = ev?.points?.[0]?.y;
      if (Number.isFinite(v)) {
        const midi = diabetesToMidi(v);
        const note = Tone.Frequency(midi, "midi").toNote();
        synth.triggerAttackRelease(note, "8n");
      }
    }
  });
})();
</script>
</body>
</html>
